/*
 * bsaseq Nextflow Pipeline Configuration
 */

manifest {
    name = 'bsaseq'
    author = 'BSAseq Authors'
    description = 'Bulk Segregant Analysis for QTL mapping'
    version = '1.0.0'
    mainScript = 'main.nf'
    nextflowVersion = '>=23.04.0'
    defaultBranch = 'main'
}

// Default parameters
params {
    // Output
    outdir = "results"

    // Analysis
    window_size = 1000000
    step_size = 250000
    min_dp = 10
    max_dp = 200
    min_gq = 20
    min_qual = 30
    min_variants = 5
    z_threshold = 3.0
    mode = "recessive"

    // Annotation
    annotate = false
    snpeff_db = null
    snpeff_mem = "4g"

    // Plotting
    plot_format = "both"

    // Help
    help = false
}

// Execution profiles
profiles {
    standard {
        process.container = 'username/bsaseq:latest'
        docker.enabled = true
        docker.runOptions = '-u $(id -u):$(id -g)'
    }

    singularity {
        process.container = 'docker://username/bsaseq:latest'
        singularity.enabled = true
        singularity.autoMounts = true
    }

    apptainer {
        process.container = 'docker://username/bsaseq:latest'
        apptainer.enabled = true
        apptainer.autoMounts = true
    }

    conda {
        process.conda = "${projectDir}/environment.yml"
        conda.enabled = true
    }

    mamba {
        process.conda = "${projectDir}/environment.yml"
        conda.enabled = true
        conda.useMamba = true
    }

    slurm {
        process.executor = 'slurm'
        process.queue = 'normal'
        process.memory = '16 GB'
        process.time = '4h'
        process.clusterOptions = '--account=default'
    }

    sge {
        process.executor = 'sge'
        process.queue = 'all.q'
        process.memory = '16 GB'
        process.time = '4h'
    }

    lsf {
        process.executor = 'lsf'
        process.queue = 'normal'
        process.memory = '16 GB'
        process.time = '4h'
    }

    local {
        process.executor = 'local'
        process.cpus = 1
        process.memory = '8 GB'
    }

    test {
        params.vcf = "${projectDir}/test/data/test.vcf.gz"
        params.high_bulk = "mut1"
        params.low_bulk = "wt1"
        params.outdir = "${projectDir}/test/results"
    }

    debug {
        process.beforeScript = 'echo "Starting process: $task.process"'
        process.afterScript = 'echo "Finished process: $task.process"'
        cleanup = false
    }
}

// Process defaults
process {
    cpus = 1
    memory = '8 GB'
    time = '2h'

    errorStrategy = { task.exitStatus in [143, 137, 104, 134, 139, 140, 247] ? 'retry' : 'finish' }
    maxRetries = 2
    maxErrors = '-1'

    // Resource scaling on retry
    memory = { 8.GB * task.attempt }
    time = { 2.h * task.attempt }
}

// Execution reports
timeline {
    enabled = true
    file = "${params.outdir}/pipeline_info/timeline.html"
    overwrite = true
}

report {
    enabled = true
    file = "${params.outdir}/pipeline_info/report.html"
    overwrite = true
}

trace {
    enabled = true
    file = "${params.outdir}/pipeline_info/trace.txt"
    overwrite = true
    fields = 'task_id,hash,native_id,process,tag,name,status,exit,submit,start,complete,duration,realtime,%cpu,rss,peak_rss,vmem,peak_vmem'
}

dag {
    enabled = true
    file = "${params.outdir}/pipeline_info/dag.svg"
    overwrite = true
}

// Capture exit codes from upstream processes
process.shell = ['/bin/bash', '-euo', 'pipefail']

// Cleanup work directory on successful completion
cleanup = true
